{% extends 'AppTimesCalc/base.html' %}
{% load crispy_forms_tags %}

{% block content %}

<!---- adapted from
https://www.tutorialrepublic.com/html-tutorial/html5-geolocation.php
https://simpleisbetterthancomplex.com/tutorial/2016/08/29/how-to-work-with-ajax-request-with-django.html
https://www.youtube.com/watch?v=fEYx8dQr_cQ for the tutorial
--->

<div id="result"><small>
    <!--Position information will be inserted here-->
</small></div>

<button class="btn btn-primary" id="search_btn" disabled>Show stores</button>

<form>
    {{ form|crispy}}
</form>

<ul id='store_list' class="list-group-flush">
    <!--Storelist information will be inserted here-->
</ul>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> 
<script>
$(document).ready(function(){
    var result, lat, lon;
    var success_url = 'process_loc';

    // Store the element where the page displays the result
    result = document.getElementById("result");

    // If geolocation is available, try to get the visitor's position
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
        result.innerHTML = "Getting the position information...";
    } else{
        alert("Sorry, your browser does not support HTML5 geolocation.");
    }

    $('#search_btn').on('click', function(){
        populateList()
    })

    function successCallback(position) {
        lat = position.coords.latitude;
        lon = position.coords.longitude;
        result.innerHTML = "Found your location"
        $('#search_btn').prop('disabled', false);
        populateList()
    }

    function errorCallback(){
        result.innerHTML = "Could not find your location, sorry."
    }

    function populateList(){
        var $my_list = $('#store_list')
        $.ajax({
            type: "GET",
            url: success_url,
            data:{
                'lat': lat,
                'lon': lon,
                'search_distance': $('#id_search_distance').val(),
                'sort_by': $('#id_sort_by').val(),
                'results_limit': limit = $('#id_results_limit').val()
            },
            dataType : "json",
            success: function(stores) {
                $my_list.empty()
                $.each(stores, function(i, store){
                    var new_row = '<li class="list-group-item">' + store.name + 
                        ', ' + store.distance + ' km </li>'
                    $my_list.append(new_row)
                })
            },
        })

    }
});

</script>


{% endblock %}